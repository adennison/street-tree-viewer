<html>
	<head>
		<title>Leederville Street Trees</title>
		<script src="leaflet/leaflet.js"></script>
		<script src="turf/turf.js"></script>
		<script src="makimarkers/Leaflet.MakiMarkers.js"></script>
		<script src="geodesy/leaflet-geodesy.js"></script>
		<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
		<script src="http://code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
		<script src="data/trees.json"></script>
		<link rel="stylesheet" href="leaflet/leaflet.css" />
		<link rel="stylesheet" href="trees.css" />
		<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
		<link rel="stylesheet" href="http://jqueryui.com/jquery-wp-content/themes/jqueryui.com/style.css">
	</head>
	<body>
		<div id="map" style="width: 100%; height: 100%"></div>
		<script>
		$(function() {
			$( "#slider" ).slider({
				orientation: "vertical",
				value:100,
				min: 0,
				max: 500,
				step: 50,
				slide: function( event, ui ) {
					$( "#amount" ).val( "$" + ui.value );
				}
			});
			$( "#amount" ).val( "$" + $( "#slider" ).slider( "value" ) );
		});

		$( "#slider" ).on( "slide", function( event, ui ) {
			console.log('slide');
		});

		var mapCenter = [-31.9374, 115.84308];
		var walkBuffer = 100;

			// Create map object
			var map = L.map('map', {
				center: mapCenter,
				zoom: 17,
				attributionControl: false,
				zoomControl: false
			});

			// Add base layers
			var osm = L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {id: 'examples.map-i875mjb7'}).addTo(map);

			// Create tree icon
			var treeIcon = L.MakiMarkers.icon({
				icon: "park2",
				color: "#39E347",
				size: "m"
			});

			// Create nearest tree icon
			var nearestIcon = L.MakiMarkers.icon({
				icon: "park2",
				color: "#13851C",
				size: "m"
			});

			// Create background tree icon
			var backgroundIcon = L.MakiMarkers.icon({
				icon: "park2",
				color: "#CCCCCC",
				size: "s"
			});

			// Create person icon
			var personIcon = L.MakiMarkers.icon({
				icon: "school",
				color: "#514e4e",
				size: "m"
			});

			var trees_all = L.geoJson(st_trees, {
				onEachFeature: onEachFeature,
				pointToLayer: function (feature, latlng) {
					return L.marker(latlng, {icon: backgroundIcon});
				}
			}).addTo(map);

			// Add tree layer
			var trees = L.geoJson(st_trees, {
				onEachFeature: onEachFeature,
				pointToLayer: function (feature, latlng) {
					return L.marker(latlng, {icon: treeIcon});
				}
			}).addTo(map);

			// Empty nearest tree layer
			var nearestMarker = L.marker();
			nearestMarker.setIcon(nearestIcon);

			// Add person layer
			var person = L.marker(mapCenter, {
				icon: personIcon,
				draggable: true
			}).addTo(map);

			// Create a point buffer polygon
			var personBuffer = LGeo.circle(mapCenter, walkBuffer, {
				stroke: false,
				fillColor: "#514e4e"
			});

			// Add personBuffer to a feature group
			var buffer = L.featureGroup().addLayer(personBuffer).addTo(map)

			// Update viewable trees
			updateTrees()

			// On drag get the new marker position and update the viewable trees
			person.on('drag', function (e) {
				resizeBuffer(buffer, person.getLatLng().lat, person.getLatLng().lng, walkBuffer);
				updateTrees()
			});

			trees.on({
				mouseover: openTreePopup,
				mouseOut: closeTreePopup
			});

			trees_all.on({
				mouseover: openTreePopup,
				mouseOut: closeTreePopup
			});

			nearestMarker.on('mouseover', function (e) {
				e.target.openPopup();
			});

			nearestMarker.on('mouseout', function (e) {
				e.target.closePopup();
			});

			// Create custom slider
			sliderControl = function(theSliderControlFunction) {
				var slideControl = new (L.Control.extend({
					options: { position: 'topleft' },
					onAdd: function (map) {
						sliderDiv = L.DomUtil.create('div', 'slider');
						sliderDiv.id = 'slider';

						return sliderDiv;
					}
				}));

				return slideControl;
			};

			// Add slider control
			map.addControl(sliderControl());

			function resizeBuffer(buffer,lat,lng,bufferSize) {
				buffer.clearLayers();
				personBuffer = LGeo.circle([lat,lng], bufferSize, {
					stroke: false,
					fillColor: "#514e4e"
				})
				buffer.addLayer(personBuffer);
			};

			// Update trees layer with trees inside the current buffer
			function updateTrees() {
				trees_fc = trees_all.toGeoJSON();
				buffer_fc = turf.featurecollection([personBuffer.toGeoJSON()]);
				within = turf.within(trees_fc, buffer_fc);
				trees.clearLayers();
				trees.addData(within);

				map.removeLayer(nearestMarker);
				nearest = turf.nearest(person.toGeoJSON(),trees_fc);
				nearestMarker.setLatLng([nearest.geometry.coordinates[1],nearest.geometry.coordinates[0]]).addTo(map);

				var popup = L.popup({closeButton: false}).setContent('<i>' + nearest.properties.species_nm + '</i>');
				nearestMarker.bindPopup(popup);
			}

			// Add popups to tree layer
			function onEachFeature(feature, layer) {
				if (feature.properties.species_nm) {
					var popup = L.popup({closeButton: false}).setContent('<i>' + feature.properties.species_nm + '</i>');
					layer.bindPopup(popup);
				};

				// layer.on({
				// 	mouseover: openTreePopup,
				// 	mouseOut: closeTreePopup
				// });
			}

			function openTreePopup(e) {
				e.layer.openPopup();
			};

			function closeTreePopup(e) {
				e.layer.closePopup();
			};
		</script>
	</body>
</html>

