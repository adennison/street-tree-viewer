<html>
	<head>
		<title>Leederville Street Trees</title>
		<script src="leaflet/leaflet.js"></script>
		<script src="turf/turf.js"></script>
		<script src="makimarkers/Leaflet.MakiMarkers.js"></script>
		<script src="geodesy/leaflet-geodesy.js"></script>
		<script src="jquery/jquery-1.10.2.min.js"></script>
		<script src="jquery/jquery-ui.min.js"></script>
		<script src="slider-pips/jquery-ui-slider-pips.js"></script>
		<script src="data/trees.json"></script>
		<link rel="stylesheet" href="leaflet/leaflet.css" />
		<link rel="stylesheet" href="trees.css" />
		<link rel="stylesheet" href="jquery/jquery-ui.css">
		<link rel="stylesheet" href="slider-pips/jquery-ui-slider-pips.css">
	</head>
	<body>
		<div id="map" style="width: 100%; height: 100%"></div>
		<script>
			$(function() {
				$( "#slider" ).slider({
					orientation: "vertical",
					value: window.bufferSize,
					min: 50,
					max: 200,
					step: 50,
					slide: function( event, ui ) {
						window.bufferSize = ui.value
						resizeBuffer(buffer, person.getLatLng().lat, person.getLatLng().lng, window.bufferSize)
						updateTreeMarkers();
					},
					start: function () {
						map.dragging.disable();
					},
					stop: function () {
						map.dragging.enable();
					},
				}).slider("pips", {
					suffix: "m"
				});
			});

			// ***** Map Object *****
			var mapCenter = [-31.9374, 115.84308];
			window.bufferSize = 100;

			// Create map object
			var map = L.map('map', {
				center: mapCenter,
				zoom: 18,
				attributionControl: false
			});

			// ***** Icons *****
			// Create tree icon
			var treeIcon = L.MakiMarkers.icon({
				icon: "park2",
				color: "#39E347",
				size: "m"
			});

			// Create nearest tree icon
			var nearestIcon = L.MakiMarkers.icon({
				icon: "park2",
				color: "#13851C",
				size: "m"
			});

			// Create background tree icon
			var backgroundIcon = L.MakiMarkers.icon({
				icon: "park2",
				color: "#CCCCCC",
				size: "s"
			});

			// Create person icon
			var personIcon = L.MakiMarkers.icon({
				icon: "school",
				color: "#514e4e",
				size: "m"
			});

			// ***** Layers *****
			// Add base layer
			var osm = L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {id: 'examples.map-i875mjb7'}).addTo(map);

			// Add person layer
			var person = L.marker(mapCenter, {
				icon: personIcon,
				draggable: true
			}).addTo(map);

			person.setZIndexOffset(1000);

			// Create a point buffer polygon
			var personBuffer = LGeo.circle(mapCenter, window.bufferSize, {
				stroke: false,
				fillColor: "#514e4e"
			});

			// Add personBuffer to a feature group
			var buffer = L.featureGroup().addLayer(personBuffer).addTo(map);

			// Add tree layer
			var trees = L.geoJson(st_trees, {
				onEachFeature: onEachFeature,
				pointToLayer: function (feature, latlng) {
					return L.marker(latlng, {icon: treeIcon});
				}
			}).addTo(map);

			updateTreeMarkers();

			// ***** Events *****
			// On drag get the new marker position and update the viewable trees
			person.on('drag', function (e) {
				resizeBuffer(buffer, person.getLatLng().lat, person.getLatLng().lng, window.bufferSize);
				updateTreeMarkers();
			});

			trees.on({
				mouseover: openTreePopup,
				mouseout: closeTreePopup
			});

			// ***** Controls *****
			// Create custom side-pane
			sidebarControl = function(theSidebarControlFunction) {
				window.controlSidebar = new (L.Control.extend({
					options: { position: 'topright' },
					onAdd: function (map) {
						controlDiv = L.DomUtil.create('div', 'sidebar-control');
						controlDiv.id = 'sidebar';
						return controlDiv;
					}
				}));
				return controlSidebar;
			};

			// Create custom slider
			sliderControl = function(theSliderControlFunction) {
				var slideControl = new (L.Control.extend({
					options: { position: 'bottomleft' },
					onAdd: function (map) {
						sliderDiv = L.DomUtil.create('div', 'slider');
						sliderDiv.id = 'slider';
						return sliderDiv;
					}
				}));
				return slideControl;
			};

			// Add slider control
			map.addControl(sliderControl());

			// ***** Functions *****
			function resizeBuffer(buffer,lat,lng,bufferSize) {
				buffer.clearLayers();
				personBuffer = LGeo.circle([lat,lng], bufferSize, {
					stroke: false,
					fillColor: "#514e4e"
				})
				buffer.addLayer(personBuffer);
			};

			function updateTreeMarkers() {
				person.setZIndexOffset(1000);

				for (layer in trees._layers) {
					trees_fc = trees.toGeoJSON();
					layer_fc = turf.featurecollection([trees.getLayer(layer).toGeoJSON()]);
					buffer_fc = turf.featurecollection([personBuffer.toGeoJSON()]);
					within = turf.within(layer_fc, buffer_fc);
					nearest = turf.nearest(person.toGeoJSON(),trees_fc);
					treeCoords = trees.getLayer(layer).toGeoJSON().geometry.coordinates;
					nearestCoords = nearest.geometry.coordinates;

					if (treeCoords[0] == nearestCoords[0] & treeCoords[1] == nearestCoords[1]) {
						trees.getLayer(layer).setIcon(nearestIcon)
					}
					else if (within.features.length == 1) {
						trees.getLayer(layer).setIcon(treeIcon)
					}
					else {
						trees.getLayer(layer).setIcon(backgroundIcon)
					};
				};
			}

			// Add popups to tree layer
			function onEachFeature(feature, layer) {
				if (feature.properties.species_nm) {
					var popup = L.popup({closeButton: false}).setContent('<i>' + feature.properties.species_nm + '</i>');
					layer.bindPopup(popup);
				};
			};

			function openTreePopup(e) {
				map.addControl(sidebarControl());
				e.layer.openPopup();

				controlDiv.innerHTML = '<b>' + e.layer.feature.properties.species_nm + '</b>' + '</br>' + '</br>' +
					'<b>' + 'Date: ' + '</b>'+ e.layer.feature.properties.date + '</br>' +
					'<b>' + 'Site Type: ' + '</b>' + e.layer.feature.properties.site_type + '</br>' +
					'<b>' + 'Health: ' + '</b>' + e.layer.feature.properties.health + '</br>' +
					'<b>' + 'Height: ' + '</b>' + e.layer.feature.properties.height + '</br>' +
					'<b>' + 'Crown Diameter: ' + '</b>' + e.layer.feature.properties.crown_diam + 'm' + '</br>' +
					'<b>' + 'Leaf Cover: ' + '</b>' + e.layer.feature.properties.leaf_cover + '</br>' +
					'<b>' + 'Tree Size: ' + '</b>' + e.layer.feature.properties.tree_size + '</br>';
			};

			function closeTreePopup(e) {
				map.removeControl(controlSidebar);
				e.layer.closePopup();
				controlDiv.innerHTML = '';
			};
		</script>
	</body>
</html>