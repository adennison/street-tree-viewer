<html>
	<head>
		<title>Park Viewer</title>
		<script src="leaflet/leaflet.js"></script>
		<script src="turf/turf.js"></script>
		<script src="makimarkers/Leaflet.MakiMarkers.js"></script>
		<script src="geodesy/leaflet-geodesy.js"></script>
		<script src="data/pos_parks.json"></script>
		<link rel="stylesheet" href="leaflet/leaflet.css" />
	</head>
	<body>
		<div id="map" style="width: 100%; height: 100%"></div>
		<script>
			// Create map object
			var map = L.map('map').setView([-31.9522, 115.8589], 15);

			// Add base layers
			var osm = L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {id: 'examples.map-i875mjb7'}).addTo(map);

			// var parks_tiles = L.tileLayer.wms("http://ns2.gaiaresources.com.au:8080/geoserver/UWA-POS/wms", {
			// 	layers: 'UWA-POS:pos_pos',
			// 	format: 'image/png',
			// 	transparent: true,
			// }).addTo(map);

			// Create park icon
			var parkIcon = L.MakiMarkers.icon({
				icon: "park2",
				color: "#39E347",
				size: "m"
			});

			// Create nearest park icon
			var nearestIcon = L.MakiMarkers.icon({
				icon: "park2",
				color: "#13851C",
				size: "m"
			});

			// Create background park icon
			var backgroundIcon = L.MakiMarkers.icon({
				icon: "park2",
				color: "#CCCCCC",
				size: "s"
			});

			// Create person icon
			var personIcon = L.MakiMarkers.icon({
				icon: "school",
				color: "#514e4e",
				size: "m"
			});

			var parks_all = L.geoJson(pos_parks, {
				onEachFeature: onEachFeature,
				pointToLayer: function (feature, latlng) {
					return L.marker(latlng, {icon: backgroundIcon});
				}
			}).addTo(map);

			// Add park layer
			var parks = L.geoJson(pos_parks, {
				onEachFeature: onEachFeature,
				pointToLayer: function (feature, latlng) {
					return L.marker(latlng, {icon: parkIcon});
				}
			}).addTo(map);

			// Empty nearest park layer
			var nearestMarker = L.marker();
			nearestMarker.setIcon(nearestIcon);

			// Add person layer
			var person = L.marker([-31.9522, 115.8589], {
				icon: personIcon,
				draggable: true
			}).addTo(map);

			// Create a point buffer polygon
			var personBuffer = LGeo.circle([-31.9522, 115.8589], 500, {
				stroke: false,
				fillColor: "#514e4e"
			});

			// Add personBuffer to a feature group
			var buffer = L.featureGroup().addLayer(personBuffer).addTo(map)

			// Update viewable parks
			updateParks()

			// On drag get the new marker position and update the viewable parks
			person.on('drag', function (e) {
				var position = person.getLatLng();

				buffer.clearLayers();
				personBuffer = LGeo.circle([position.lat, position.lng], 500, {
					stroke: false,
					fillColor: "#514e4e"
				})
				buffer.addLayer(personBuffer);

				updateParks()
			});

			parks.on('mouseover', function (e) {
				e.layer.openPopup();
			});

			parks.on('mouseout', function (e) {
				e.layer.closePopup();
			});

			// Update parks layer with parks inside the current buffer
			function updateParks() {
				parks_fc = parks_all.toGeoJSON();
				buffer_fc = turf.featurecollection([personBuffer.toGeoJSON()]);
				within = turf.within(parks_fc, buffer_fc);
				parks.clearLayers();
				parks.addData(within);

				map.removeLayer(nearestMarker);
				nearest = turf.nearest(person.toGeoJSON(),parks_fc);
				nearestMarker.setLatLng([nearest.geometry.coordinates[1],nearest.geometry.coordinates[0]]).addTo(map); 
			}

			// Add popups to park layer
			function onEachFeature(feature, layer) {
				if (feature.properties.park_name) {
					var popup = L.popup({closeButton: false}).setContent(feature.properties.park_name);
					layer.bindPopup(popup);
				};
			}
		</script>
	</body>
</html>

